# Immediate DNS Fix for Unraid - Temporary Workaround

**Status**: Tailscale DNS configuration not propagating yet.

**Immediate workaround**: Add fallback DNS directly to `/etc/resolv.conf` via boot script.

---

## Issue Found

Your Tailscale shows:
```
"CorpDNS": true  ‚Üê Using Tailscale DNS
/etc/resolv.conf shows: nameserver 100.100.100.100  ‚Üê Still default
```

The Tailscale admin console DNS settings haven't propagated to your Unraid device yet. This can take a few minutes or may require additional configuration.

---

## Immediate Fix (Works Right Now)

### Step 1: Add Fallback DNS via Boot Script

This adds Pi-hole as fallback DNS after Tailscale starts:

```bash
ssh root@192.168.0.51

# Edit go script (runs on every boot)
nano /boot/config/go
```

**Add at the end** (before any existing commands):
```bash
# Wait for Tailscale to configure DNS
sleep 30

# Add Pi-hole fallback DNS servers
echo "nameserver 192.168.0.19" >> /etc/resolv.conf
echo "nameserver 100.112.203.63" >> /etc/resolv.conf
echo "nameserver 1.1.1.1" >> /etc/resolv.conf
```

**Save** (Ctrl+O, Enter, Ctrl+X)

### Step 2: Run Script Now (Don't Wait for Reboot)

```bash
# Add DNS servers right now
echo "nameserver 192.168.0.19" >> /etc/resolv.conf
echo "nameserver 100.112.203.63" >> /etc/resolv.conf
echo "nameserver 1.1.1.1" >> /etc/resolv.conf

# Verify
cat /etc/resolv.conf
```

**Expected output**:
```
# resolv.conf(5) file generated by tailscale
nameserver 100.100.100.100
search tailc12764.ts.net
nameserver 192.168.0.19      ‚Üê Pi-hole LAN
nameserver 100.112.203.63    ‚Üê Pi-hole Tailscale
nameserver 1.1.1.1           ‚Üê Cloudflare
```

### Step 3: Test DNS Resolution

```bash
# Test Docker registries
nslookup index.docker.io
nslookup ghcr.io
nslookup lscr.io

# All should resolve successfully
# Will try 100.100.100.100 first, then fallback to Pi-hole if needed
```

### Step 4: Test Docker Pull

```bash
# Test simple pull
docker pull hello-world:latest

# Test from problematic registries
docker pull ghcr.io/linuxserver/alpine:latest

# Should work now
```

---

## Why This Works

**DNS resolution order**:
1. Tries `100.100.100.100` (Tailscale DNS)
2. If that fails or times out ‚Üí tries `192.168.0.19` (Pi-hole LAN)
3. If that fails ‚Üí tries `100.112.203.63` (Pi-hole Tailscale)
4. If that fails ‚Üí tries `1.1.1.1` (Cloudflare)

**Result**: Even when Tailscale DNS misbehaves, your system falls back to reliable Pi-hole.

---

## Verify Tailscale Admin Console Settings

While the boot script fix works, let's make sure your Tailscale admin console is configured correctly:

### Check Tailscale Admin Console

1. **Open**: https://login.tailscale.com/admin/dns

2. **Verify "Global nameservers" section shows**:
   ```
   100.112.203.63
   192.168.0.19
   1.1.1.1
   ```

3. **Verify "Override local DNS" is enabled** (toggle should be blue/ON)

4. **If not configured**, add them:
   - Click "Add nameserver"
   - Select "Custom..."
   - Enter: `100.112.203.63`
   - Click "Save"
   - Repeat for `192.168.0.19` and `1.1.1.1`

5. **Enable Override**:
   - Scroll to "Override local DNS"
   - Toggle **ON**

### Force Tailscale to Refresh Config

After verifying admin console settings:

```bash
ssh root@192.168.0.51

# Restart Tailscale daemon completely
killall tailscaled
sleep 5
/etc/rc.d/rc.tailscale start

# Or if that doesn't work
tailscale logout
tailscale login  # Follow link to re-authenticate
```

**Then check**:
```bash
cat /etc/resolv.conf
# Should eventually show Pi-hole IPs
```

---

## Test Container Updates

Now test if Watchtower can successfully update containers:

```bash
ssh root@192.168.0.51

# Check watchtower status
docker ps | grep watchtower

# View recent logs
docker logs watchtower --tail 50

# Manually trigger update check
docker restart watchtower

# Watch logs
docker logs -f watchtower
# Press Ctrl+C to exit

# Look for:
# ‚úÖ "Found new image" ‚Üí Good
# ‚ùå "Unable to update" ‚Üí Still failing
# ‚ùå "server misbehaving" ‚Üí DNS still problematic
```

---

## Monitor in Grafana

Check if DNS errors have stopped:

1. **Open Grafana**: http://192.168.0.19:3000

2. **Go to Explore** or open Container Health dashboard

3. **Query**:
   ```
   {hostname="unraid-server", container="watchtower"} |~ "(?i)unable|misbehaving"
   ```

4. **Time range**: Last 1 hour

5. **Should see**: No new errors after applying the fix

---

## Permanent Solution Timeline

**Current state**:
- ‚úÖ Temporary fix applied (boot script adds fallback DNS)
- ‚è≥ Tailscale admin console configured (waiting to propagate)
- ‚è≥ May take 5-30 minutes for Tailscale to sync new DNS settings

**Once Tailscale DNS propagates**:
- `/etc/resolv.conf` will show Pi-hole IPs first
- Boot script still helpful as additional fallback
- Can optionally remove boot script if Tailscale DNS is reliable

---

## Verification Checklist

### ‚úÖ Immediate Fix Applied

- [ ] `/boot/config/go` edited with DNS fallback commands
- [ ] DNS servers added to `/etc/resolv.conf` right now
- [ ] `cat /etc/resolv.conf` shows 4 nameservers (Tailscale + 3 fallbacks)
- [ ] `nslookup index.docker.io` resolves successfully
- [ ] `docker pull hello-world:latest` works

### ‚úÖ Tailscale Admin Console

- [ ] Logged into https://login.tailscale.com/admin/dns
- [ ] Global nameservers include: 100.112.203.63, 192.168.0.19, 1.1.1.1
- [ ] "Override local DNS" is enabled (blue toggle)

### ‚úÖ Updates Working

- [ ] Watchtower running: `docker ps | grep watchtower`
- [ ] No DNS errors in logs: `docker logs watchtower | grep -i misbehaving`
- [ ] Manual pull works: `docker pull lscr.io/linuxserver/plex:latest`

### ‚úÖ Persistence Test

- [ ] Reboot Unraid: `reboot`
- [ ] Wait 5 minutes
- [ ] SSH back in: `ssh root@192.168.0.51`
- [ ] Check DNS: `cat /etc/resolv.conf` (should have fallback servers)
- [ ] Test DNS: `nslookup index.docker.io` (should work)

---

## Quick Test Commands

Run these to verify everything works:

```bash
ssh root@192.168.0.51

# 1. Check DNS config
cat /etc/resolv.conf

# 2. Test DNS resolution (all should succeed)
nslookup index.docker.io
nslookup ghcr.io
nslookup lscr.io

# 3. Test Docker pulls
docker pull hello-world:latest
docker pull ghcr.io/linuxserver/alpine:latest

# 4. Check watchtower
docker logs watchtower --tail 20 | grep -i "session done"

# 5. View DNS errors (should be none recent)
docker logs watchtower | grep -i "misbehaving" | tail -5
```

---

## Expected Results

### ‚úÖ Good (Fixed)

```bash
$ cat /etc/resolv.conf
nameserver 100.100.100.100
nameserver 192.168.0.19       ‚Üê Added
nameserver 100.112.203.63     ‚Üê Added
nameserver 1.1.1.1            ‚Üê Added

$ nslookup index.docker.io
Server:         192.168.0.19  ‚Üê Using Pi-hole!
Address:        192.168.0.19#53
...
Name:   index.docker.io
Address: 54.84.93.253

$ docker pull hello-world:latest
latest: Pulling from library/hello-world
‚úì Pull complete
```

### ‚ùå Bad (Not Fixed)

```bash
$ cat /etc/resolv.conf
nameserver 100.100.100.100    ‚Üê Only Tailscale DNS
search tailc12764.ts.net

$ nslookup index.docker.io
;; connection timed out; no servers could be reached
```

---

## Troubleshooting

### DNS Servers Not Added

**Check `/boot/config/go` was edited**:
```bash
cat /boot/config/go | grep resolv.conf
# Should show the echo commands
```

**Re-run manually**:
```bash
echo "nameserver 192.168.0.19" >> /etc/resolv.conf
echo "nameserver 100.112.203.63" >> /etc/resolv.conf
echo "nameserver 1.1.1.1" >> /etc/resolv.conf
```

### DNS Resolution Still Fails

**Check network connectivity**:
```bash
# Test Pi-hole is reachable
ping 192.168.0.19
ping 100.112.203.63

# Test direct DNS query
dig @192.168.0.19 google.com
```

**Check Pi-hole is listening**:
```bash
ssh automation@100.112.203.63
sudo netstat -tulpn | grep :53
# Should show listening on port 53
```

### Watchtower Still Fails

**Check watchtower logs**:
```bash
docker logs watchtower --tail 100 | grep -i error
```

**If still showing DNS errors**:
- Restart watchtower: `docker restart watchtower`
- Restart Docker completely: `/etc/rc.d/rc.docker restart`

### Changes Lost After Reboot

**Check `/boot/config/go` is executable**:
```bash
ls -la /boot/config/go
# Should be: -rwx------ (executable)

# If not executable:
chmod +x /boot/config/go
```

**Check boot logs**:
```bash
dmesg | grep -i "go script"
```

---

## Summary

**What we did**:
1. ‚úÖ Added fallback DNS servers to `/etc/resolv.conf`
2. ‚úÖ Made changes persistent via `/boot/config/go` script
3. ‚úÖ Verified Tailscale admin console is configured
4. ‚è≥ Waiting for Tailscale DNS to propagate (may take time)

**Current status**:
- DNS resolution should work now (using fallbacks)
- Container updates should succeed
- Changes persist across reboots

**Next**:
- Monitor Grafana for DNS errors (should be 0)
- Check watchtower logs after next scheduled run
- Wait for Tailscale DNS to propagate fully

---

**Created**: 2025-11-06
**Status**: Immediate fix applied, waiting for Tailscale propagation
**Time to apply**: 5 minutes

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
