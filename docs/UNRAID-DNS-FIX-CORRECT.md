# Correct DNS Fix for Unraid - Tailscale Configuration

**Issue**: Container updates failing due to Tailscale DNS (100.100.100.100) intermittently failing.

**Root Cause**: You tried to configure Docker daemon DNS, but Unraid doesn't use standard `/etc/docker/daemon.json`.

**Correct Solution**: Configure Tailscale to use your Pi-hole as DNS server.

---

## The Right Way: Configure Tailscale DNS

### Step 1: Configure Tailscale to Use Pi-hole

This is the **correct** solution for Unraid + Tailscale.

1. **Open Tailscale Admin Console**:
   - Go to: https://login.tailscale.com/admin/dns
   - Login with your Tailscale account

2. **Add Pi-hole as Global Nameserver**:
   - Scroll to "Global nameservers" section
   - Click: **"Add nameserver"**
   - Select: **"Custom..."**
   - Enter IP: `100.112.203.63` (your Raspberry Pi Tailscale IP)
   - Optional name: "Pi-hole"
   - Click: **"Save"**

3. **Add Fallback DNS (Recommended)**:
   - Click: **"Add nameserver"** again
   - Select: **"Custom..."**
   - Enter IP: `192.168.0.19` (Pi-hole LAN IP - works when on home network)
   - Click: **"Save"**

   - Click: **"Add nameserver"** again
   - Select: **"Cloudflare"** or enter `1.1.1.1`
   - Click: **"Save"**

4. **Enable Override Local DNS**:
   - Scroll down to "Override local DNS" section
   - Toggle: **ON** (blue)
   - This forces all Tailscale devices to use these nameservers

5. **Your configuration should look like**:
   ```
   Global nameservers:
     100.112.203.63 (Pi-hole Tailscale)
     192.168.0.19 (Pi-hole LAN)
     1.1.1.1 (Cloudflare fallback)

   Override local DNS: Enabled âœ“
   ```

### Step 2: Restart Tailscale on Unraid

```bash
ssh root@192.168.0.51

# Restart Tailscale to pick up new DNS settings
tailscale down
sleep 2
tailscale up

# Check new DNS configuration
cat /etc/resolv.conf
```

**Expected output**:
```
# resolv.conf(5) file generated by tailscale
nameserver 100.112.203.63
nameserver 192.168.0.19
nameserver 1.1.1.1
search tailc12764.ts.net
```

**If it still shows only `100.100.100.100`**:
- Wait 1-2 minutes for Tailscale to sync config
- Run `tailscale status` to verify connected
- Try `tailscale down && tailscale up --accept-dns` to force DNS acceptance

### Step 3: Configure Pi-hole to Accept Tailscale Queries

Your Pi-hole needs to listen on its Tailscale interface:

```bash
ssh automation@100.112.203.63

# Check if Pi-hole is running as Docker or native
docker ps | grep pihole
```

#### If Pi-hole is Docker (Likely):

```bash
# Get container name
PIHOLE_CONTAINER=$(docker ps --format '{{.Names}}' | grep -i pihole)

# Edit Pi-hole config
docker exec $PIHOLE_CONTAINER pihole -a -i local

# Or manually configure
sudo mkdir -p /etc/dnsmasq.d/
sudo tee /etc/dnsmasq.d/99-tailscale.conf <<EOF
# Listen on Tailscale interface
interface=tailscale0
listen-address=100.112.203.63
EOF

# Restart Pi-hole
docker restart $PIHOLE_CONTAINER
```

#### Check Pi-hole Web Interface:

1. Open: http://192.168.0.19/admin (or http://100.112.203.63/admin)
2. Login
3. Settings â†’ DNS
4. **Interface listening behavior**:
   - Select: **"Listen on all interfaces"**
   - Or: **"Listen on all interfaces, permit all origins"** (less restrictive, works better)
5. Click: **"Save"**

#### Configure Firewall (if needed):

```bash
ssh automation@100.112.203.63

# Check current firewall
sudo ufw status
# Or
sudo firewall-cmd --list-all

# Allow DNS from Tailscale network
sudo ufw allow from 100.0.0.0/8 to any port 53 comment 'DNS from Tailscale'

# Or for firewalld
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="100.0.0.0/8" port port="53" protocol="udp" accept'
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="100.0.0.0/8" port port="53" protocol="tcp" accept'
sudo firewall-cmd --reload
```

### Step 4: Test DNS Resolution

On Unraid:

```bash
ssh root@192.168.0.51

# Test DNS is working
nslookup google.com

# Test Docker registries
nslookup index.docker.io
nslookup registry-1.docker.io
nslookup ghcr.io
nslookup lscr.io

# All should resolve WITHOUT "server misbehaving" error
```

### Step 5: Test Docker Can Pull Images

```bash
ssh root@192.168.0.51

# Test simple pull
docker pull hello-world:latest

# Test from registries that were failing
docker pull ghcr.io/linuxserver/alpine:latest
docker pull lscr.io/linuxserver/plex:latest

# All should succeed
```

### Step 6: Verify Pi-hole is Being Used

**Check Pi-hole query log**:

1. Open Pi-hole: http://192.168.0.19/admin
2. Click: **Query Log**
3. Look for queries from: `100.69.191.4` (Unraid's Tailscale IP)

**Or via command line**:
```bash
ssh automation@100.112.203.63

# Check recent queries from Unraid
docker logs pihole | grep "100.69.191.4" | tail -20

# Or check Pi-hole database
sqlite3 /etc/pihole/pihole-FTL.db "SELECT * FROM queries WHERE client='100.69.191.4' ORDER BY timestamp DESC LIMIT 10;"
```

---

## If Tailscale DNS Config Doesn't Work

### Alternative: Modify Unraid Docker Startup Script

If for some reason Tailscale DNS configuration doesn't apply, we can modify how Unraid starts Docker:

```bash
ssh root@192.168.0.51

# Backup rc.docker script
cp /etc/rc.d/rc.docker /boot/config/rc.docker.backup

# Edit rc.docker
nano /etc/rc.d/rc.docker
```

**Find the line** (around line 200):
```bash
$DOCKER -p $DOCKER_PIDFILE --log-opt max-size=$DOCKER_LOG_SIZE ...
```

**Add DNS flags** before `--storage-driver`:
```bash
$DOCKER -p $DOCKER_PIDFILE --log-opt max-size=$DOCKER_LOG_SIZE --log-opt max-file=$DOCKER_LOG_FILES --log-level=fatal \
  --dns 192.168.0.19 \
  --dns 100.112.203.63 \
  --dns 1.1.1.1 \
  --dns-search tailc12764.ts.net \
  --storage-driver=$DOCKER_BACKINGFS
```

**Save file** (Ctrl+O, Enter, Ctrl+X)

**Restart Docker**:
```bash
/etc/rc.d/rc.docker restart
```

**âš ï¸ Warning**: This will restart all containers.

**Verify Docker DNS**:
```bash
# Check dockerd process
ps aux | grep dockerd | grep dns

# Should show:
# dockerd ... --dns 192.168.0.19 --dns 100.112.203.63 ...
```

**Make persistent**:
```bash
# Copy modified script to boot
cp /etc/rc.d/rc.docker /boot/config/rc.docker

# Add to /boot/config/go to restore on boot
echo 'cp /boot/config/rc.docker /etc/rc.d/rc.docker' >> /boot/config/go
```

---

## Test Watchtower Updates

Now that DNS is fixed, let's test if updates work:

```bash
ssh root@192.168.0.51

# Manually trigger watchtower to check for updates
docker start watchtower

# Watch watchtower logs
docker logs -f watchtower

# Press Ctrl+C to exit

# Look for these patterns:
# âœ… Good: "Found new <image>" followed by "Stopping" and "Creating"
# âŒ Bad: "Unable to update" or "server misbehaving"
```

---

## Permanent Fix Summary

**What we did**:

1. âœ… **Configured Tailscale** to use Pi-hole (100.112.203.63) as primary DNS
2. âœ… **Added fallbacks**: Pi-hole LAN (192.168.0.19) + Cloudflare (1.1.1.1)
3. âœ… **Enabled "Override local DNS"** in Tailscale (forces all devices to use Pi-hole)
4. âœ… **Configured Pi-hole** to listen on Tailscale interface
5. âœ… **Tested** DNS resolution and Docker image pulls

**Why this works**:

```
Before:
Unraid â†’ Tailscale DNS (100.100.100.100) â†’ âŒ Intermittent failures
       â†“
Watchtower â†’ DNS fails â†’ Container removed

After:
Unraid â†’ Tailscale â†’ Pi-hole (100.112.203.63) â†’ âœ… Reliable resolution
       â†“
Watchtower â†’ DNS succeeds â†’ Container updated successfully
       â†“
Fallback to 192.168.0.19 or 1.1.1.1 if Pi-hole down
```

**Additional benefits**:
- âœ… All Tailscale devices now use Pi-hole (ad-blocking everywhere)
- âœ… Faster DNS (local Pi-hole vs public DNS)
- âœ… DNS queries logged in Pi-hole (see what your network is accessing)
- âœ… Works even when away from home (via Tailscale)

---

## Verification Checklist

### âœ… DNS Configuration

- [ ] Tailscale admin shows Pi-hole as global nameserver
- [ ] `/etc/resolv.conf` on Unraid shows `100.112.203.63`
- [ ] `nslookup index.docker.io` resolves without errors
- [ ] `nslookup google.com` works
- [ ] `docker pull hello-world:latest` succeeds

### âœ… Pi-hole Integration

- [ ] Pi-hole query log shows queries from `100.69.191.4` (Unraid Tailscale IP)
- [ ] Pi-hole listening on Tailscale interface (check with `netstat -tulpn | grep :53`)
- [ ] Firewall allows Tailscale network to port 53

### âœ… Persistence

- [ ] Reboot Unraid: `reboot`
- [ ] Wait 5 minutes
- [ ] SSH back in: `ssh root@192.168.0.51`
- [ ] Check DNS still configured: `cat /etc/resolv.conf`
- [ ] Test DNS works: `nslookup index.docker.io`

### âœ… Container Updates

- [ ] Watchtower running: `docker ps | grep watchtower`
- [ ] No DNS errors in logs: `docker logs watchtower | grep -i "server misbehaving"`
- [ ] Manually test update: `docker pull lscr.io/linuxserver/plex:latest`
- [ ] Check Grafana Container Health dashboard: DNS Errors = 0

---

## If Updates Still Fail

**Check watchtower logs**:
```bash
ssh root@192.168.0.51
docker logs watchtower --tail 100
```

**Look for**:
- âœ… "Found new image" â†’ Success
- âŒ "Unable to update" â†’ Still failing
- âŒ "dial tcp: lookup ... on 100.100.100.100:53" â†’ DNS not configured
- âŒ "dial tcp: lookup ... on 100.112.203.63:53" â†’ Pi-hole not responding

**If still using 100.100.100.100**:
- Tailscale DNS config didn't apply
- Try: `tailscale down && tailscale up --accept-dns`
- Verify: `cat /etc/resolv.conf`

**If using 100.112.203.63 but timing out**:
- Pi-hole not listening on Tailscale interface
- Check: `ssh automation@100.112.203.63 "netstat -tulpn | grep :53"`
- Firewall blocking: Check UFW/firewalld rules

**If using 100.112.203.63 but "server misbehaving"**:
- Pi-hole interface settings wrong
- Fix: Pi-hole admin â†’ Settings â†’ DNS â†’ Interface: "Listen on all interfaces"

---

## Monitoring in Grafana

After fixing, monitor in Grafana:

**Container Health Dashboard**:
1. Open: http://192.168.0.19:3000/d/container-health
2. Check panels:
   - DNS Errors (1h) = **0** (green)
   - Update Failures (24h) = **0** (green)
   - Active Containers = **28+** (green)

**Set up alert**:
- Alert if DNS errors > 5 in 5 minutes
- Alert if update failures > 3 in 10 minutes

---

## Quick Commands

**Full test sequence**:
```bash
# On Unraid
ssh root@192.168.0.51

# 1. Check DNS config
cat /etc/resolv.conf

# 2. Test DNS resolution
nslookup index.docker.io
nslookup ghcr.io

# 3. Test Docker pull
docker pull hello-world:latest

# 4. Check watchtower
docker logs watchtower --tail 50

# 5. Test update
docker pull lscr.io/linuxserver/plex:latest
```

**Check Pi-hole is being used**:
```bash
# Open Pi-hole
http://192.168.0.19/admin

# Query Log â†’ Look for 100.69.191.4
```

---

## Expected Timeline

- **Tailscale DNS config**: 2 minutes
- **Pi-hole configuration**: 3 minutes
- **Testing**: 5 minutes
- **Reboot test**: 10 minutes (wait for boot)

**Total**: ~20 minutes to permanent fix

---

## Need Help?

If you're stuck at any step, check:

1. **Tailscale Admin Console**: Verify DNS servers are saved
2. **Unraid `/etc/resolv.conf`**: Should show Pi-hole IPs
3. **Pi-hole Query Log**: Should see Unraid queries
4. **Watchtower Logs**: Should not show DNS errors

**Debug commands**:
```bash
# Unraid DNS
ssh root@192.168.0.51 "cat /etc/resolv.conf"

# Pi-hole listening
ssh automation@100.112.203.63 "netstat -tulpn | grep :53"

# Test direct query to Pi-hole
dig @100.112.203.63 google.com

# Watchtower recent activity
ssh root@192.168.0.51 "docker logs watchtower --tail 50"
```

---

**Created**: 2025-11-06
**Status**: Ready to implement
**Time**: ~20 minutes
**Difficulty**: Easy (web UI configuration)

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
