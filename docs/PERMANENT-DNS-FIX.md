# Permanent DNS Fix for Unraid + Tailscale Pi-hole Configuration

**Issues to Fix**:
1. âŒ Unraid DNS changes are temporary (lost on reboot)
2. âŒ Tailscale devices not using Pi-hole as DNS resolver

---

## Part 1: Make Unraid DNS Permanent

### The Problem

Tailscale regenerates `/etc/resolv.conf` on every boot, overwriting your DNS changes:
```
# resolv.conf(5) file generated by tailscale
nameserver 100.100.100.100  # Only Tailscale DNS
```

### Solution A: Configure Tailscale to Use Pi-hole (Best)

**This configures Tailscale network-wide to use your Pi-hole as DNS.**

#### Step 1: Add Pi-hole as Tailscale Global Nameserver

1. **Open Tailscale Admin Console**: https://login.tailscale.com/admin/dns

2. **Add Nameservers**:
   - Click "Add nameserver"
   - Select: **Custom...**
   - Enter: `100.112.203.63` (Raspberry Pi Tailscale IP)
   - Click "Save"

3. **Add LAN Pi-hole as Fallback** (if on same network):
   - Click "Add nameserver" again
   - Enter: `192.168.0.19` (Pi-hole LAN IP)
   - Click "Save"

4. **Configure Search Domain**:
   - Under "Search domains"
   - Should see: `tailc12764.ts.net`
   - Add: `lan` or your local domain if you have one

5. **Enable Override Local DNS**:
   - Toggle on: **Override local DNS**
   - This forces all Tailscale devices to use these nameservers

**Expected result**:
```
Global nameservers:
  100.112.203.63 (sweetrpi-desktop)
  192.168.0.19
```

#### Step 2: Test Configuration

```bash
# On Unraid, restart Tailscale to pick up new DNS
ssh root@192.168.0.51

# Restart Tailscale
tailscale down
tailscale up

# Wait 10 seconds, then check resolv.conf
cat /etc/resolv.conf
```

**Should now show**:
```
nameserver 100.112.203.63
nameserver 192.168.0.19
nameserver 100.100.100.100
search tailc12764.ts.net
```

#### Step 3: Verify DNS Works

```bash
ssh root@192.168.0.51

# Test Pi-hole is responding
nslookup google.com 100.112.203.63

# Test Docker registry resolution
nslookup index.docker.io
nslookup ghcr.io
nslookup lscr.io

# All should resolve without "server misbehaving"
```

### Solution B: Docker Daemon DNS Override (Fallback)

**If you prefer not to change Tailscale DNS network-wide**, configure Docker to use Pi-hole directly:

```bash
ssh root@192.168.0.51

# Edit or create Docker daemon config
nano /etc/docker/daemon.json
```

**Add or merge** (if file exists, merge with existing content):
```json
{
  "dns": ["192.168.0.19", "100.112.203.63", "1.1.1.1"],
  "dns-search": ["tailc12764.ts.net"]
}
```

**Save and restart Docker**:
```bash
# Save file (Ctrl+O, Enter, Ctrl+X)

# Restart Docker daemon
/etc/rc.d/rc.docker restart

# Verify containers restarted
docker ps
```

**âš ï¸ Warning**: This restarts all Docker containers.

### Solution C: Unraid `/boot/config/go` Script (Least Preferred)

**Only use if solutions A & B don't work.**

```bash
ssh root@192.168.0.51

# Backup existing go script
cp /boot/config/go /boot/config/go.backup

# Edit go script
nano /boot/config/go
```

**Add at the end**:
```bash
#!/bin/bash
# Add fallback DNS servers after Tailscale starts
sleep 30  # Wait for Tailscale to start

# Check if Tailscale has modified resolv.conf
if grep -q "generated by tailscale" /etc/resolv.conf; then
    # Add Pi-hole fallback
    echo "nameserver 192.168.0.19" >> /etc/resolv.conf
    echo "nameserver 1.1.1.1" >> /etc/resolv.conf
fi
```

**Make executable**:
```bash
chmod +x /boot/config/go
```

**Test** (or wait for next reboot):
```bash
# Simulate boot
/boot/config/go

# Check resolv.conf
cat /etc/resolv.conf
```

---

## Part 2: Configure Tailscale to Use Pi-hole Network-Wide

**This makes ALL devices on your Tailscale use Pi-hole for DNS.**

### Step 1: Verify Pi-hole is Accessible via Tailscale

```bash
# From any Tailscale device
ping 100.112.203.63

# Test Pi-hole DNS
nslookup google.com 100.112.203.63

# Should resolve successfully
```

### Step 2: Configure Tailscale DNS Settings

1. **Login to Tailscale**: https://login.tailscale.com/admin/dns

2. **Global Nameservers** section:
   - Click "Add nameserver"
   - Select "Custom..."
   - Enter: `100.112.203.63`
   - **Name**: Pi-hole (sweetrpi-desktop)
   - Click "Save"

3. **Optional - Add Cloudflare as Fallback**:
   - Click "Add nameserver"
   - Enter: `1.1.1.1`
   - Click "Save"

4. **Restrict to Tailscale IPs** (optional but recommended):
   - Under nameserver `100.112.203.63`
   - Click "Edit"
   - Check: "Restrict to Tailscale network"
   - This prevents DNS leaks to public internet

5. **Enable Override Local DNS**:
   - Scroll down to "Override local DNS"
   - Toggle: **ON**
   - This forces all devices to use Pi-hole

**Final configuration should look like**:
```
Global nameservers:
  âœ“ 100.112.203.63 (Pi-hole - sweetrpi-desktop)
  âœ“ 1.1.1.1 (Cloudflare fallback)

Override local DNS: Enabled

Search domains:
  tailc12764.ts.net
```

### Step 3: Configure Pi-hole to Accept Tailscale Queries

Your Pi-hole needs to accept DNS queries from Tailscale network.

```bash
ssh automation@100.112.203.63

# Edit Pi-hole dnsmasq config
sudo nano /etc/dnsmasq.d/02-pihole-tailscale.conf
```

**Add**:
```
# Allow DNS queries from Tailscale network
interface=tailscale0
listen-address=100.112.203.63
listen-address=192.168.0.19
listen-address=127.0.0.1
```

**Restart Pi-hole**:
```bash
docker exec pihole pihole restartdns
# Or if Pi-hole is native
pihole restartdns
```

### Step 4: Update Pi-hole Interface Settings

**Via Web UI**:

1. Open Pi-hole: http://192.168.0.19/admin
2. Login
3. Settings â†’ DNS
4. **Interface listening behavior**:
   - Select: "Listen on all interfaces, permit all origins"
   - Or: "Listen on all interfaces" (more restrictive)
5. Click "Save"

### Step 5: Configure Firewall (If Needed)

If Pi-hole firewall is blocking Tailscale DNS queries:

```bash
ssh automation@100.112.203.63

# Allow DNS from Tailscale network
sudo ufw allow from 100.0.0.0/8 to any port 53 proto udp comment 'Pi-hole DNS from Tailscale'
sudo ufw allow from 100.0.0.0/8 to any port 53 proto tcp comment 'Pi-hole DNS from Tailscale'

# Or if using firewalld
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="100.0.0.0/8" port port="53" protocol="udp" accept'
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="100.0.0.0/8" port port="53" protocol="tcp" accept'
sudo firewall-cmd --reload
```

### Step 6: Test from All Devices

**On each Tailscale device**:

```bash
# Restart Tailscale to pick up new DNS
sudo tailscale down
sudo tailscale up

# Check resolv.conf (Linux/macOS)
cat /etc/resolv.conf
# Should show 100.112.203.63

# Test DNS resolution
nslookup google.com
nslookup index.docker.io

# Verify queries going through Pi-hole
nslookup doubleclick.net
# Should return 0.0.0.0 (blocked by Pi-hole)
```

**On Unraid specifically**:

```bash
ssh root@192.168.0.51

tailscale down && tailscale up
cat /etc/resolv.conf
nslookup index.docker.io
```

---

## Verification Checklist

### âœ… Unraid DNS is Permanent

- [ ] `/etc/resolv.conf` includes fallback DNS servers
- [ ] Docker can resolve all registries: `nslookup index.docker.io ghcr.io lscr.io`
- [ ] Changes persist after reboot: `ssh root@192.168.0.51 reboot` (wait 5 min) then check
- [ ] Watchtower can pull images: `ssh root@192.168.0.51 "docker pull hello-world:latest"`

### âœ… Tailscale Uses Pi-hole

- [ ] Tailscale admin shows Pi-hole as global nameserver
- [ ] All devices have `100.112.203.63` in their DNS config
- [ ] Test query reaches Pi-hole: Check Pi-hole web UI â†’ Query Log
- [ ] Ads are blocked on Tailscale devices: Visit `http://doubleclick.net` (should be blocked)
- [ ] Fallback works: Stop Pi-hole, DNS still resolves (via 1.1.1.1)

### âœ… No DNS Errors in Logs

```bash
# Check for recent DNS errors
ssh automation@100.112.203.63 "curl -G -s 'http://localhost:3100/loki/api/v1/query' --data-urlencode 'query={hostname=\"unraid-server\"} |~ \"server misbehaving\"' | jq '.data.result[].values[][-1]'"

# Should return empty or very old entries
```

---

## Why This Fixes the Problem

### Before (Broken)

```
Unraid â†’ Tailscale DNS (100.100.100.100) â†’ âŒ Intermittent failures
    â†“
Watchtower tries to pull image
    â†“
DNS lookup fails: "server misbehaving"
    â†“
Container removed, update fails
```

### After (Fixed)

**Option 1: Tailscale â†’ Pi-hole**
```
Unraid â†’ Tailscale pushes Pi-hole DNS
    â†“
/etc/resolv.conf: 100.112.203.63 (Pi-hole)
    â†“
Watchtower â†’ Pi-hole (192.168.0.19) â†’ âœ… Always resolves
    â†“
Update succeeds
```

**Option 2: Docker Direct to Pi-hole**
```
Unraid â†’ Tailscale DNS (default)
    â†“
Docker daemon â†’ Pi-hole (192.168.0.19) directly
    â†“
Watchtower â†’ Pi-hole â†’ âœ… Bypasses Tailscale DNS
    â†“
Update succeeds
```

---

## Benefits of Pi-hole via Tailscale

Once configured, you get:

âœ… **Ad-blocking everywhere** - All Tailscale devices block ads via Pi-hole
âœ… **Better privacy** - DNS queries stay on your network
âœ… **Faster resolution** - Local Pi-hole is faster than public DNS
âœ… **DNS-level tracking** - See all DNS queries in Pi-hole logs
âœ… **Custom DNS records** - Add local DNS entries in Pi-hole
âœ… **Redundancy** - Fallback to Cloudflare if Pi-hole is down

**Example use case**:
- Your phone on mobile data (via Tailscale)
- Uses Pi-hole DNS via Tailscale IP
- Blocks ads system-wide (even in apps!)
- No VPN needed for this

---

## Troubleshooting

### Tailscale DNS Not Working

**Check Tailscale status**:
```bash
tailscale status
# All devices should show "active"
```

**Check DNS configuration**:
```bash
tailscale status --json | jq '.DNSConfig'
```

**Force refresh**:
```bash
sudo tailscale down
sudo tailscale up --accept-dns
```

### Pi-hole Not Responding on Tailscale IP

**Check Pi-hole is listening**:
```bash
ssh automation@100.112.203.63
sudo netstat -tulpn | grep :53
# Should show listening on 100.112.203.63:53
```

**Test direct query**:
```bash
dig @100.112.203.63 google.com
# Should return A records
```

**Check Pi-hole logs**:
```bash
ssh automation@100.112.203.63
docker logs pihole | tail -50
# Or if native: tail -f /var/log/pihole.log
```

### Docker Still Has DNS Issues

**Check Docker DNS config**:
```bash
ssh root@192.168.0.51
docker info | grep -A 10 "DNS"
```

**Test DNS from inside container**:
```bash
docker run --rm busybox nslookup google.com
```

### Changes Don't Persist on Reboot

**Check `/boot/config/go` runs**:
```bash
ssh root@192.168.0.51
ls -la /boot/config/go
# Should be executable: -rwx------
```

**Check boot logs**:
```bash
dmesg | grep -i dns
```

---

## Recommended Configuration

**For your setup, I recommend**:

1. âœ… **Use Tailscale global DNS** pointing to Pi-hole
   - Simplest
   - Works network-wide
   - All devices get ad-blocking

2. âœ… **Add Docker daemon DNS override** on Unraid as backup
   - Ensures Docker always works
   - Doesn't rely on system DNS

3. âœ… **Monitor in Grafana**
   - Use Container Health dashboard
   - Alert on DNS failures
   - Track update success rate

**This gives you defense in depth**:
- Primary: Tailscale â†’ Pi-hole
- Backup: Docker â†’ Pi-hole direct
- Fallback: Cloudflare public DNS

---

## Quick Commands

**Apply all fixes** (run in order):

```bash
# 1. Configure Tailscale DNS (do this in web UI first)
# https://login.tailscale.com/admin/dns
# Add: 100.112.203.63

# 2. Configure Docker DNS on Unraid
ssh root@192.168.0.51
cat > /etc/docker/daemon.json <<'EOF'
{
  "dns": ["192.168.0.19", "100.112.203.63", "1.1.1.1"],
  "dns-search": ["tailc12764.ts.net"]
}
EOF

# 3. Restart Docker
/etc/rc.d/rc.docker restart

# 4. Restart Tailscale on Unraid
tailscale down && tailscale up

# 5. Test
nslookup index.docker.io
docker pull hello-world:latest

# 6. Reboot to verify persistence
reboot
```

**After reboot** (wait 5 minutes):
```bash
ssh root@192.168.0.51
cat /etc/resolv.conf
docker info | grep DNS
nslookup index.docker.io
```

---

## Interview Talking Points

### DNS Hierarchy & Redundancy

*"I configured DNS with multiple layers of redundancy: Tailscale network DNS pointing to my Pi-hole as primary, with Docker daemon override as backup, and Cloudflare as fallback. This defense-in-depth approach ensures container updates never fail due to DNS issues."*

### Network Architecture

*"I integrated Pi-hole into my Tailscale mesh network, allowing all my devices - even when mobile - to use my self-hosted DNS for ad-blocking and privacy. This demonstrates understanding of overlay networks and DNS resolver configuration."*

### Troubleshooting Methodology

*"When I discovered the DNS issue was causing container update failures, I implemented a multi-layered fix: network-level (Tailscale), application-level (Docker daemon), and monitoring-level (Grafana alerts). This ensures the issue can't recur even if one layer fails."*

---

## Summary

**Fix 1: Unraid DNS Permanent**
â†’ Configure Docker daemon DNS override in `/etc/docker/daemon.json`

**Fix 2: Tailscale Uses Pi-hole**
â†’ Add `100.112.203.63` as global nameserver in Tailscale admin console

**Test**:
```bash
ssh root@192.168.0.51 "nslookup index.docker.io && docker pull hello-world:latest"
```

**Monitor**:
â†’ Container Health dashboard in Grafana (DNS Errors panel should be 0)

---

**Created**: 2025-11-06
**Status**: Ready to implement
**Time to apply**: 10-15 minutes

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
