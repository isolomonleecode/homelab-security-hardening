# Vulnerability Assessment Report - Session 6
**Date:** November 1, 2025
**Scope:** Unraid Server + Raspberry Pi Homelab Environment
**Assessment Tool:** Trivy Container Scanner

---

## Executive Summary

Comprehensive vulnerability scanning was performed across 23 containers on Unraid and 8 containers on Raspberry Pi. This report identifies critical security risks requiring immediate remediation and provides actionable recommendations.

### Critical Findings

| System | Container | CRITICAL | HIGH | Risk Level |
|--------|-----------|----------|------|------------|
| Unraid | watchtower | 4 | 26 | **SEVERE** |
| Unraid | nextcloud-db (MariaDB) | 3 | 42 | **SEVERE** |
| Raspberry Pi | Vaultwarden | 2 | 293 | **HIGH** |
| Raspberry Pi | Promtail | 6 | 30 | **HIGH** |

**Total Vulnerabilities Identified:**
- **CRITICAL:** 15
- **HIGH:** 391
- **MEDIUM:** Numerous (not prioritized in this report)

---

## Unraid Server Vulnerability Analysis

### Container Scan Summary

| Container | Image | CRITICAL | HIGH | Status |
|-----------|-------|----------|------|--------|
| watchtower | containrrr/watchtower | 4 | 26 | ⚠️ **Action Required** |
| nextcloud-db | mariadb:11 | 3 | 42 | ⚠️ **Action Required** |
| postgresql17 | postgres:17 | 0 | 11 | ⚠️ Review Recommended |
| binhex-radarr | ghcr.io/binhex/arch-radarr | 0 | 12 | ⚠️ Review Recommended |
| binhex-readarr | binhex/arch-readarr | 0 | 12 | ⚠️ Review Recommended |
| binhex-sonarr | binhex/arch-sonarr | 0 | 13 | ⚠️ Review Recommended |
| homarr | ghcr.io/homarr-labs/homarr:latest | 0 | 10 | ⚠️ Review Recommended |
| NginxProxyManager | jlesage/nginx-proxy-manager | 0 | 3 | ✅ Low Risk |
| MeTube | alexta69/metube | 0 | 2 | ✅ Low Risk |
| freshrss | lscr.io/linuxserver/freshrss | 0 | 0 | ✅ Clean |
| nextcloud-redis | redis:alpine | 0 | 0 | ✅ Clean |
| adminer | adminer | 0 | 0 | ✅ Clean |
| Unraid-Cloudflared-Tunnel | figro/unraid-cloudflared-tunnel | 0 | 0 | ✅ Clean |

**Scan Failures:** 8 containers (unmanic, binhex-flaresolverr, nextcloud, binhex-prowlarr, binhex-jellyfin, bazarr, plex, binhex-lidarr, binhex-overseerr, binhex-delugevpn)
- **Reason:** Likely proprietary/layered images that Trivy cannot analyze
- **Recommendation:** Manual security review or alternative scanning methods required

---

### Critical Vulnerability #1: Watchtower

**Container:** watchtower
**Image:** containrrr/watchtower
**Risk Level:** SEVERE
**Vulnerabilities:** 4 CRITICAL, 26 HIGH, 28 MEDIUM, 1 LOW

#### Critical CVEs

1. **CVE-2024-41110** - Docker/Moby Authorization Bypass (CRITICAL)
   - **Component:** github.com/docker/docker v24.0.7
   - **Impact:** Authz zero length regression allows bypassing authorization plugins
   - **Fixed Versions:** 23.0.15, 25.0.6, 26.1.5, 27.1.1
   - **Severity:** Remote attackers could bypass Docker authorization controls

2. **CVE-2023-24538** - Golang HTML Template Injection (CRITICAL)
   - **Component:** stdlib 1.18.10
   - **Impact:** Backticks not properly sanitized in HTML templates
   - **Fixed Versions:** 1.19.8, 1.20.3
   - **Severity:** Potential XSS/code injection

3. **CVE-2023-24540** - Golang JavaScript Whitespace Handling (CRITICAL)
   - **Component:** stdlib 1.18.10
   - **Impact:** Improper handling of JavaScript whitespace in templates
   - **Fixed Versions:** 1.19.9, 1.20.4
   - **Severity:** Potential XSS/code injection

4. **CVE-2024-24790** - Golang IPv4-Mapped IPv6 Address Handling (CRITICAL)
   - **Component:** stdlib 1.18.10
   - **Impact:** Unexpected behavior from Is methods for IPv4-mapped IPv6 addresses
   - **Fixed Versions:** 1.21.11, 1.22.4
   - **Severity:** Network security bypass potential

#### Notable HIGH Severity Issues

- **CVE-2022-41722**: Path traversal in filepath.Clean
- **CVE-2023-39325**: HTTP/2 rapid stream reset DoS (HTTP/2 Rapid Reset Attack)
- **CVE-2023-45288**: Unlimited CONTINUATION frames DoS
- **CVE-2024-34156**: Decoder.Decode deeply nested structures DoS
- Multiple additional CVEs from outdated Go stdlib (1.18.10)

#### Root Cause

Watchtower image is built with:
- **Very old Go version (1.18.10)** - Released in 2022, multiple critical patches since
- **Outdated Docker SDK (v24.0.7)** - Missing critical authorization fixes

#### Remediation Strategy

**Option 1: Update to Latest Watchtower (RECOMMENDED)**
```bash
docker pull containrrr/watchtower:latest
docker stop watchtower
docker rm watchtower
# Redeploy with updated image
```

**Option 2: Replace with Manual Update Script**
- Watchtower automates container updates but introduces risk
- Consider scheduled manual updates via script instead

**Option 3: Disable Watchtower**
- If not actively needed, disable to eliminate attack surface

---

### Critical Vulnerability #2: MariaDB/Nextcloud Database

**Container:** nextcloud-db
**Image:** mariadb:11
**Risk Level:** SEVERE
**Vulnerabilities:** 3 CRITICAL, 42 HIGH (in gosu utility)

#### Critical CVEs

The CRITICAL vulnerabilities are in the `gosu` binary (v1.18.2), not MariaDB itself:

1. **CVE-2023-24538** - Golang HTML Template Injection
   - **Component:** stdlib in gosu 1.18.2
   - **Impact:** Backticks not treated as string delimiters
   - **Fixed Versions:** 1.19.8, 1.20.3

2. **CVE-2023-24540** - Golang JavaScript Whitespace Handling
   - **Component:** stdlib in gosu 1.18.2
   - **Fixed Versions:** 1.19.9, 1.20.4

3. **CVE-2024-24790** - Golang IPv4-Mapped IPv6 Address Handling
   - **Component:** stdlib in gosu 1.18.2
   - **Fixed Versions:** 1.21.11, 1.22.4

#### MariaDB OS Packages

MariaDB container itself (debian 12.11) shows:
- 0 CRITICAL vulnerabilities in MariaDB
- Minor vulnerabilities in system packages (glibc, etc.)

#### Root Cause

- MariaDB official image uses an outdated version of `gosu` (privilege escalation tool)
- Gosu is built with Go 1.18.2 (released 2022), containing known critical vulnerabilities
- MariaDB functionality itself is not directly affected

#### Remediation Strategy

**Option 1: Update to Latest MariaDB Image**
```bash
# Backup database first!
docker exec nextcloud-db mariadb-dump --all-databases > nextcloud-db-backup-$(date +%Y%m%d).sql

# Pull latest MariaDB 11 image
docker pull mariadb:11

# Recreate container with new image
docker stop nextcloud-db
docker rm nextcloud-db
# Redeploy with updated image
```

**Option 2: Wait for Official Image Update**
- MariaDB maintainers will eventually update gosu in the image
- Monitor mariadb:11 image updates

**Option 3: Custom Build with Updated Gosu**
- Build custom MariaDB image with updated gosu binary
- Requires Dockerfile maintenance

**RECOMMENDED: Option 1** - Update to latest mariadb:11 image after backing up database

---

## Raspberry Pi Vulnerability Analysis

### Container Scan Summary

| Container | Image | CRITICAL | HIGH | Status |
|-----------|-------|----------|------|--------|
| vaultwarden | vaultwarden/server:latest | 2 | 293 | ⚠️ **High Risk** |
| promtail | grafana/promtail:2.9.6 | 6 | 30 | ⚠️ **Action Required** |
| portainer | portainer/portainer-ee:latest | 0 | 11 | ⚠️ Review Recommended |
| portainer-updater | portainer/portainer-updater:2.33.2 | 0 | 11 | ⚠️ Review Recommended |
| caddy | caddy:latest | 0 | 11 | ⚠️ Review Recommended |
| pihole | pihole/pihole:latest | 0 | 0 | ✅ Clean |
| grafana | grafana/grafana:latest | (not scanned) | - | - |
| prometheus | prom/prometheus:latest | (not scanned) | - | - |
| loki | grafana/loki:latest | (not scanned) | - | - |
| node-exporter | prom/node-exporter:latest | (not scanned) | - | - |

---

### Critical Vulnerability #3: Vaultwarden

**Container:** vaultwarden
**Image:** vaultwarden/server:latest
**Risk Level:** HIGH
**Vulnerabilities:** 2 CRITICAL, 293 HIGH

#### Critical CVEs

1. **CVE-2025-4802** - glibc Static setuid Binary dlopen Vulnerability
   - **Component:** libc-bin, libc6 2.36-9+deb12u10
   - **Impact:** Static setuid binaries may incorrectly search LD_LIBRARY_PATH
   - **Fixed Version:** 2.36-9+deb12u11
   - **Severity:** Privilege escalation potential

2. **(Additional CRITICAL - truncated in output)**

#### Analysis

- **Impact:** Vaultwarden stores password vault data - **EXTREMELY SENSITIVE**
- **Current Protection:** Restricted to Tailscale network via UFW firewall
- **Risk:** OS-level vulnerabilities in Debian 12.11 base image

#### Remediation Strategy

**Option 1: Update Vaultwarden Image (RECOMMENDED)**
```bash
# Backup Vaultwarden data first!
docker exec vaultwarden sqlite3 /data/db.sqlite3 ".backup '/data/backup-$(date +%Y%m%d).sqlite3'"

# Update to latest image
docker pull vaultwarden/server:latest
docker stop vaultwarden
docker rm vaultwarden
# Redeploy
```

**Option 2: Monitor for Security Updates**
- Vaultwarden team actively maintains security
- Subscribe to Vaultwarden security announcements

**Additional Security Recommendations:**
1. Enable 2FA for all Vaultwarden accounts (if not already enabled)
2. Regular backups of /data directory
3. Consider external backup to encrypted storage
4. Review Vaultwarden audit logs regularly

---

### Critical Vulnerability #4: Promtail (Log Collector)

**Container:** promtail
**Image:** grafana/promtail:2.9.6
**Risk Level:** HIGH
**Vulnerabilities:** 6 CRITICAL, 30 HIGH

#### Critical CVEs

1. **CVE-2022-3715** - Bash Heap Buffer Overflow
   - **Component:** bash 5.1-2+deb11u1
   - **Impact:** Heap-buffer-overflow in valid_parameter_transform
   - **Status:** Affected (no fix available)

2. **CVE-2022-1304** - e2fsprogs Out-of-Bounds Read/Write
   - **Component:** e2fsprogs 1.46.2-2
   - **Fixed Version:** 1.46.2-2+deb11u1

3. **CVE-2024-2961** - glibc Out of Bounds Write
   - **Component:** libc-bin 2.31-13+deb11u8
   - **Impact:** Remote code execution potential via iconv
   - **Fixed Version:** 2.31-13+deb11u9

4. **CVE-2024-33599** - glibc Stack-Based Buffer Overflow
   - **Component:** libc-bin 2.31-13+deb11u8
   - **Impact:** Netgroup cache overflow
   - **Fixed Version:** 2.31-13+deb11u10

5-6. **(Additional CRITICAL vulnerabilities)**

#### Root Cause

- Promtail 2.9.6 is based on **Debian 11.9** (oldstable)
- Contains multiple outdated system packages with known critical vulnerabilities
- glibc version 2.31 is significantly outdated

#### Remediation Strategy

**Option 1: Update to Latest Promtail (RECOMMENDED)**
```bash
# Update to Promtail 3.x (latest stable)
docker pull grafana/promtail:latest
docker stop promtail
docker rm promtail
# Redeploy with new image
```

**Option 2: Use Promtail 3.x Based on Newer Debian**
- Promtail 3.x uses newer base images
- Significantly reduced vulnerability count

**Note:** Configuration changes may be needed when upgrading major versions

---

## Remediation Priority Matrix

### Priority 1: IMMEDIATE ACTION (Critical + Exposed Services)

| Container | Risk Factor | Recommended Action | Downtime |
|-----------|-------------|-------------------|----------|
| **watchtower** | Critical CVEs + Docker API access | Update or disable | None (auto-restart) |
| **vaultwarden** | Critical CVEs + sensitive data | Update after backup | ~5 min |

### Priority 2: HIGH PRIORITY (Critical + Internal Services)

| Container | Risk Factor | Recommended Action | Downtime |
|-----------|-------------|-------------------|----------|
| **nextcloud-db** | Critical CVEs in gosu | Update after backup | ~5-10 min (Nextcloud unavailable) |
| **promtail** | Critical CVEs in base OS | Update to 3.x | None (logging continues) |

### Priority 3: MAINTENANCE (High Vulnerabilities)

| Container | Vulns | Action | Urgency |
|-----------|-------|--------|---------|
| postgresql17 | 11 HIGH | Update to postgres:17-alpine | Medium |
| binhex-sonarr | 13 HIGH | Check for updates | Medium |
| binhex-radarr | 12 HIGH | Check for updates | Medium |
| binhex-readarr | 12 HIGH | Check for updates | Medium |
| portainer | 11 HIGH | Update to latest | Low |
| caddy | 11 HIGH | Update to latest | Low |
| homarr | 10 HIGH | Update to latest | Low |

---

## Remediation Roadmap

### Immediate (Today)

1. **Watchtower** - Update or disable (15 minutes)
   - Backup watchtower configuration
   - Pull latest image: `containrrr/watchtower:latest`
   - Redeploy with same configuration
   - Verify auto-update functionality

2. **Vaultwarden** - Update after backup (30 minutes)
   - Export password vault backup
   - Backup SQLite database: `/data/db.sqlite3`
   - Pull latest Vaultwarden image
   - Redeploy and verify login functionality
   - Test password retrieval

### High Priority (This Week)

3. **Nextcloud-db/MariaDB** - Update after backup (45 minutes)
   - **CRITICAL:** Full database backup first
   - Test backup restore on separate instance (optional but recommended)
   - Pull latest mariadb:11 image
   - Redeploy with existing volumes
   - Verify Nextcloud connectivity
   - Test Nextcloud file operations

4. **Promtail** - Upgrade to 3.x (20 minutes)
   - Review Promtail 3.x configuration changes
   - Update docker-compose.yml
   - Pull latest promtail image
   - Redeploy
   - Verify log ingestion in Loki
   - Check Grafana dashboard for metrics

### Maintenance (Next 2 Weeks)

5. **PostgreSQL** - Update to postgres:17-alpine (30 minutes)
6. **Binhex containers** - Check for base image updates (15 min each)
7. **Portainer** - Update to latest EE version (10 minutes)
8. **Caddy** - Update to latest (5 minutes)
9. **Homarr** - Update to latest (5 minutes)

---

## Backup Verification Checklist

Before any remediation, verify backups exist for:

- [ ] **Vaultwarden**
  - [ ] SQLite database backup
  - [ ] /data directory backup
  - [ ] Test restore to temporary location

- [ ] **Nextcloud Database**
  - [ ] Full mariadb-dump of all databases
  - [ ] Backup stored on separate storage
  - [ ] Backup size verified (should be ~50-200MB depending on usage)

- [ ] **Nextcloud Data**
  - [ ] User files backed up (if not already)
  - [ ] Nextcloud config.php backed up

- [ ] **Docker Compose Files**
  - [ ] All docker-compose.yml files in /home/automation/docker/
  - [ ] Portainer stack exports

- [ ] **Prometheus/Grafana**
  - [ ] Grafana dashboard JSON exports
  - [ ] Prometheus alert rules backup
  - [ ] Prometheus data retention acceptable (30 days configured)

---

## Post-Remediation Validation

After each container update:

1. **Functional Testing**
   - Container starts successfully
   - Service responds on expected ports
   - Login/authentication works
   - Core functionality verified

2. **Security Validation**
   - Re-run Trivy scan: `trivy image <image:tag>`
   - Verify vulnerability count reduced
   - Check for new vulnerabilities introduced

3. **Monitoring**
   - Check Grafana dashboard for service health
   - Review Prometheus alerts
   - Verify log ingestion in Loki

4. **Documentation**
   - Update container versions in inventory
   - Document any configuration changes
   - Note any issues encountered

---

## Long-Term Security Recommendations

### Container Image Management

1. **Automated Scanning**
   - Schedule weekly Trivy scans via cron
   - Alert on CRITICAL/HIGH vulnerabilities
   - Track vulnerability trends over time

2. **Update Policy**
   - Review security updates monthly
   - Apply critical security patches within 7 days
   - Test updates in non-production first (if possible)

3. **Image Selection**
   - Prefer official images (postgres, redis, etc.) over community
   - Use Alpine Linux-based images when available (smaller attack surface)
   - Verify image signatures and provenance

### Infrastructure Hardening

1. **Network Segmentation** (Already Implemented ✅)
   - UFW firewall configured
   - Tailscale mesh network for admin access
   - Service-specific network restrictions

2. **Access Control** (Partially Implemented)
   - Enforce 2FA on all admin interfaces
   - Regular password rotation
   - Principle of least privilege for service accounts

3. **Monitoring & Alerting** (Recently Implemented ✅)
   - Grafana security dashboard operational
   - Prometheus alerting configured
   - Log aggregation via Loki

4. **Backup Strategy** (Needs Improvement)
   - Automate critical service backups
   - Test backup restores quarterly
   - Off-site/encrypted backup storage
   - Document RTO/RPO for each service

### Compliance & Audit

1. **Monthly Security Review**
   - Review vulnerability scan results
   - Check for new CVEs in deployed software
   - Review firewall rules and access logs
   - Update security documentation

2. **Incident Response Plan**
   - Document response procedures for security incidents
   - Maintain contact list for security notifications
   - Test incident response procedures annually

---

## Risk Assessment Summary

### Current Security Posture

**Strengths:**
- ✅ Host firewall (UFW) properly configured
- ✅ Network segmentation (Tailscale + LAN restrictions)
- ✅ Intrusion prevention (fail2ban) deployed
- ✅ Monitoring and alerting infrastructure operational
- ✅ Regular security scanning implemented

**Weaknesses:**
- ⚠️ Multiple containers with CRITICAL vulnerabilities
- ⚠️ Outdated container images (some 2+ years old)
- ⚠️ No automated patching/update process
- ⚠️ Backup automation not fully implemented
- ⚠️ Some containers using non-official images (binhex/*)

### Risk Reduction After Remediation

| Metric | Current | After Priority 1-2 | Improvement |
|--------|---------|-------------------|-------------|
| CRITICAL CVEs | 15 | ~0-2 | 87-100% |
| HIGH CVEs | 391 | ~50-100 | 74-87% |
| Exposed Services with Critical CVEs | 2 | 0 | 100% |
| Attack Surface | High | Medium | 40-50% |

---

## Conclusion

This vulnerability assessment identified significant security risks across both Unraid and Raspberry Pi environments. The most critical findings are:

1. **Watchtower** - Severe vulnerabilities in Docker authorization and Go stdlib
2. **Vaultwarden** - Critical OS vulnerabilities protecting sensitive password data
3. **Nextcloud-db** - Critical vulnerabilities in privilege escalation utility
4. **Promtail** - Multiple critical OS vulnerabilities in log collector

**Immediate action is required** to update watchtower and vaultwarden to prevent potential exploitation. The comprehensive remediation roadmap provides a structured approach to addressing all identified vulnerabilities within 2 weeks.

The security posture can be significantly improved (74-100% reduction in critical vulnerabilities) by following the prioritized remediation plan and implementing the long-term security recommendations.

---

## Appendix A: Detailed Scan Reports

Full Trivy scan reports are available at:
- **Unraid:** `/root/homelab-security-hardening/findings/vulnerability-reports/`
- **Summary:** `/root/homelab-security-hardening/findings/vulnerability-summary.md`
- **CSV:** `/root/homelab-security-hardening/findings/vulnerability-summary.csv`

## Appendix B: Command Reference

### Backup Commands

```bash
# Vaultwarden backup
docker exec vaultwarden sqlite3 /data/db.sqlite3 ".backup '/data/backup-$(date +%Y%m%d).sqlite3'"

# MariaDB backup
docker exec nextcloud-db mariadb-dump --all-databases > nextcloud-db-backup-$(date +%Y%m%d).sql

# PostgreSQL backup
docker exec postgresql17 pg_dumpall -U postgres > postgresql-backup-$(date +%Y%m%d).sql
```

### Update Commands

```bash
# Generic container update
docker pull <image:tag>
docker stop <container>
docker rm <container>
# Redeploy via Portainer or docker-compose
```

### Scan Commands

```bash
# Scan running container
trivy image --severity HIGH,CRITICAL <image:tag>

# Scan all containers
for img in $(docker ps --format '{{.Image}}'); do
  echo "Scanning: $img"
  trivy image --severity HIGH,CRITICAL $img
done
```

---

**Report Generated:** November 1, 2025
**Next Review Date:** November 8, 2025
**Contact:** Generated via Claude Code
