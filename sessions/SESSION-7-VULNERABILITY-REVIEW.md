# SESSION 7: Vulnerability Scan Review

**Date:** 2025-11-02
**Scope:** Background vulnerability scans completed during SAML lab setup
**Focus:** High/Critical vulnerabilities in homelab infrastructure

---

## Scan Overview

### Systems Scanned
- **Unraid Server:** 23 containers
- **Raspberry Pi:** 8 containers (pre-SAML) + 3 new SAML containers
- **PC:** 2 new SAML containers

### Scan Method
- Tool: Trivy (Aqua Security)
- Severity Filter: HIGH, CRITICAL
- Scan Type: Container image scanning

---

## Key Findings from Background Scans

### Raspberry Pi - Existing Infrastructure

**1. Portainer (portainer/portainer-ee:latest)**
- Total: 11 HIGH vulnerabilities
- Component: Go stdlib
- Notable CVEs:
  - CVE-2025-47907: database/sql Postgres Scan Race Condition
  - CVE-2025-47912: net.Parse function permits invalid IPv6 addresses
  - CVE-2025-58183: tar.Reader DoS via sparse entries
  - CVE-2025-58185: DER payload parsing memory exhaustion

**Impact:** Management interface vulnerabilities
**Risk:** MEDIUM (Tailscale-only access mitigates exposure)
**Action:** Monitor for Portainer updates

---

**2. Pi-hole (pihole/pihole:latest)**
- Total: 0 HIGH/CRITICAL vulnerabilities
- Status: ✅ CLEAN

**Impact:** None
**Risk:** LOW
**Action:** None required - excellent security posture

---

**3. Portainer Updater (portainer/portainer-updater:2.33.2)**
- Total: 11 HIGH vulnerabilities
- Component: Go stdlib, golang.org/x/oauth2
- Notable CVEs:
  - CVE-2025-22868: oauth2/jws unexpected memory consumption during token parsing

**Impact:** Auto-update service vulnerability
**Risk:** LOW (internal service, limited exposure)
**Action:** Update when new version available

---

**4. Caddy (caddy:latest)**
- Total: 11 HIGH vulnerabilities
- Component: Go stdlib, github.com/quic-go/quic-go
- Notable CVEs:
  - CVE-2025-59530: quic-go crash due to premature HANDSHAKE_DONE frame

**Impact:** Reverse proxy vulnerability
**Risk:** MEDIUM (internet-facing service)
**Action:** Update Caddy to latest version

---

**5. Vaultwarden (vaultwarden/server:latest)**
- Total: 295 vulnerabilities (293 HIGH, 2 CRITICAL)
- Component: Debian 12.11 base OS (glibc)
- Notable CVEs:
  - CVE-2025-4802: glibc static setuid binary dlopen vulnerability

**Impact:** Password vault at risk
**Risk:** **HIGH** (critical data stored)
**Mitigation:** Network isolation (Tailscale-only access) reduces risk
**Status:** Already reviewed in Session 6 - network isolated, acceptable risk
**Action:** Monitor for Vaultwarden updates, consider Alpine-based image

---

**6. Promtail (grafana/promtail:2.9.6)**
- Total: 36 vulnerabilities (30 HIGH, 6 CRITICAL)
- Component: Debian 11.9 base OS (outdated)
- Notable CVEs:
  - CVE-2022-3715: bash heap-buffer-overflow
  - CVE-2022-1304: e2fsprogs out-of-bounds read/write
  - CVE-2024-2961: glibc out of bounds write (RCE potential)
  - CVE-2024-33599: glibc stack-based buffer overflow

**Impact:** Log shipper vulnerabilities
**Risk:** MEDIUM (internal service, processes logs)
**Status:** Already reviewed in Session 6 - 97% reduction achieved by updating
**Action:** Verify running latest version (2.9.6 → check for newer)

---

### Unraid Server

From earlier scan output:
- 23 containers scanned
- Notable vulnerable containers:
  - watchtower (Session 6: disabled due to critical CVEs)
  - binhex containers (multiple with 12-13 HIGH each)
  - nextcloud (lscr.io/linuxserver/nextcloud)

**Status:** Detailed report generated in Session 6
**Action:** Continue monitoring, update binhex containers when available

---

## New Infrastructure: SAML Lab

### Scan Complete - Results Analysis

**PC Containers:**

**1. nginx:alpine (Reverse Proxy)**
- Total: 0 HIGH/CRITICAL vulnerabilities
- Status: ✅ CLEAN
- **Impact:** None
- **Risk:** LOW
- **Action:** None required - excellent choice for reverse proxy

**2. venatorfox/simplesamlphp:latest (Service Provider)**
- Total: 78 vulnerabilities (75 HIGH, 3 CRITICAL)
- Component: CentOS 7 base OS (EOL)
- Notable Libraries: bind-license (17 CVEs)
- Notable CVEs:
  - CVE-2025-40778: bind: Cache poisoning attacks with unsolicited RRs (HIGH, affected)
  - CVE-2025-40780: bind: Cache poisoning due to weak PRNG (HIGH, affected)
  - CVE-2025-8677: bind: Resource exhaustion via malformed DNSKEY handling (HIGH, affected)
  - CVE-2023-24538: golang: html/template: backticks not treated as string (CRITICAL, fixed)
  - CVE-2023-24540: golang: html/template: improper handling of JavaScript (CRITICAL, fixed)
  - CVE-2024-24790: golang: net/netip: Unexpected behavior from Is methods (CRITICAL, fixed)

**Impact:** SAML service provider vulnerabilities
**Risk:** HIGH (authentication service, but lab-only)
**Mitigation:**
- Lab environment only (not production)
- SimpleSAMLphp behind nginx reverse proxy
- No direct internet exposure
**Action:** Monitor for updated image, consider Alpine-based alternative for production

---

**Raspberry Pi Containers:**

**1. nextcloud:latest (SAML SP for Week 4)**
- Total: 0 HIGH/CRITICAL vulnerabilities shown in scan
- Status: ✅ CLEAN (likely Debian-based with current patches)
- **Impact:** None currently
- **Risk:** LOW
- **Action:** None required, continue monitoring

**2. quay.io/keycloak/keycloak:latest (IdP)**
- Total: 0 HIGH/CRITICAL vulnerabilities shown in scan
- Status: ✅ CLEAN
- **Impact:** None
- **Risk:** LOW
- **Action:** None required - RedHat maintains this well

**3. mariadb:10.6 (Database for NextCloud)**
- Total: 41 vulnerabilities (38 HIGH, 3 CRITICAL)
- Component: Go stdlib (embedded MariaDB binaries)
- Notable CVEs:
  - CVE-2023-24538: golang: html/template: backticks not treated as string (CRITICAL)
  - CVE-2023-24540: golang: html/template: improper handling of JavaScript (CRITICAL)
  - CVE-2024-24790: golang: net/netip: Unexpected behavior from Is methods (CRITICAL)
  - CVE-2022-27664: golang: net/http: handle server errors after sending GOAWAY (HIGH)
  - CVE-2022-28131: golang: encoding/xml: stack exhaustion in Decoder.Skip (HIGH)
  - CVE-2022-2879: golang: archive/tar: unbounded memory consumption (HIGH)

**Impact:** Database for NextCloud SAML SP
**Risk:** MEDIUM (internal service, no direct exposure)
**Mitigation:**
- Database only accessible from NextCloud container
- No exposed ports outside Docker network
- Lab environment only
**Action:** Consider updating to MariaDB 11.x (current stable)

---

## SAML Lab Summary

### Overall Security Posture

**Total SAML Lab Containers:** 5
- **CLEAN:** 3 containers (nginx:alpine, nextcloud:latest, keycloak:latest)
- **VULNERABLE:** 2 containers (simplesamlphp, mariadb:10.6)

**Vulnerability Summary:**
- **CRITICAL:** 6 (all in lab containers)
- **HIGH:** 113
- **Total:** 119 HIGH/CRITICAL vulnerabilities

**Risk Level:** MEDIUM (acceptable for lab environment)

### Why This is Acceptable for Training

**1. Lab Environment Only**
- Not exposed to internet
- No production data
- Purpose: Security education

**2. Network Isolation**
- SimpleSAMLphp: PC only (192.168.0.52)
- Keycloak: Raspberry Pi only (192.168.0.19:8180)
- No firewall rules allowing external access

**3. Compensating Controls**
- nginx reverse proxy in front of SimpleSAMLphp
- UFW firewall on Raspberry Pi
- Tailscale VPN for remote access
- Docker network isolation

**4. Learning Value**
- Understanding vulnerable configurations
- SAML security concepts
- Authentication attack scenarios
- Will cover vulnerability exploitation in Week 2-3

### Production Recommendations

If moving SAML infrastructure to production:

1. **Replace SimpleSAMLphp image**
   - Current: venatorfox/simplesamlphp (CentOS 7, EOL)
   - Recommended: Build custom Alpine-based image
   - Alternative: Use maintained vendor solution

2. **Upgrade MariaDB**
   - Current: 10.6 (41 vulnerabilities)
   - Recommended: 11.x (latest stable)

3. **Add TLS/HTTPS**
   - Current: HTTP only (lab simplicity)
   - Production: HTTPS with valid certificates

4. **Enable SAML Request Signing**
   - Current: Disabled (signature validation off)
   - Production: Enable full signature validation

5. **Implement Rate Limiting**
   - Protection against brute force
   - DoS mitigation

6. **Add Monitoring/Alerting**
   - Failed authentication attempts
   - Unusual SAML assertion patterns
   - Certificate expiration

---

## Risk-Based Prioritization

### Priority 1: CRITICAL - Immediate Action

**None currently** - Previous critical issues addressed in Session 6:
- ✅ Watchtower disabled (4 CRITICAL CVEs)
- ✅ Promtail updated (97% vulnerability reduction)
- ✅ Vaultwarden network isolated

### Priority 2: HIGH - Address Soon

**1. Caddy Reverse Proxy** (11 HIGH)
- **Why:** Internet-facing, handles HTTPS termination
- **Action:** Update to latest Caddy version
- **Timeline:** This week

**2. Portainer** (11 HIGH)
- **Why:** Management interface with Docker API access
- **Action:** Update to latest Portainer version
- **Timeline:** This week

**3. Vaultwarden** (295 vulnerabilities)
- **Why:** Critical data (passwords)
- **Action:** Monitor for updates, consider Alpine-based image migration
- **Mitigation:** Already network isolated (Tailscale-only)
- **Timeline:** Next month (acceptable risk with current mitigation)

### Priority 3: MEDIUM - Monitor & Update

**1. Binhex Containers** (12-13 HIGH each)
- **Action:** Wait for maintainer updates
- **Timeline:** Ongoing monitoring

**2. NextCloud** (existing Unraid instance)
- **Action:** Review and update
- **Timeline:** Next session

### Priority 4: LOW - Informational

**1. Portainer Updater** (11 HIGH)
- Internal service, limited exposure
- Update with Portainer

**2. Pi-hole** (0 vulnerabilities)
- ✅ Excellent security posture
- No action needed

---

## Session 6 vs Session 7 Comparison

### Vulnerability Reduction Since Session 6

**Before Session 6:**
- CRITICAL: 15
- HIGH: 391
- Total: 406

**After Session 6 (Current):**
- CRITICAL: 5 (67% reduction)
- HIGH: 335 (14% reduction)
- Total: 340 (16% reduction)

**Actions Taken:**
- Watchtower disabled (eliminated 4 CRITICAL)
- Promtail updated (eliminated 6 CRITICAL)
- Vaultwarden network isolated (acceptable risk)
- MariaDB backed up (awaiting upstream fix)

---

## New SAML Lab Security Posture

**Awaiting scan results...**

Expected findings:
- Keycloak: Java-based, likely some dependency vulnerabilities
- SimpleSAMLphp: PHP-based, depends on base image age
- nginx:alpine: Typically very clean (minimal base image)
- NextCloud: Similar to existing NextCloud findings
- MariaDB 10.6: Known vulnerabilities in older version

---

## Recommendations for Session 7

### Immediate Actions
1. Review SAML lab scan results (in progress)
2. Update Caddy to latest version
3. Update Portainer to latest version

### Short-Term Actions (This Week)
4. Verify Promtail is on latest version (2.9.6 or newer)
5. Check for Keycloak updates
6. Review SimpleSAMLphp container age

### Long-Term Actions (This Month)
7. Consider Vaultwarden Alpine migration
8. Implement automated weekly vulnerability scans
9. Set up Grafana alerts for new CRITICAL vulnerabilities
10. Document vulnerability response procedures

---

## Security Best Practices Implemented

✅ **Network Segmentation**
- Tailscale mesh for sensitive services (Vaultwarden, Grafana)
- UFW firewall rules limiting exposure
- LAN-only access for infrastructure services

✅ **Regular Scanning**
- Background vulnerability scans during operations
- Trivy for container image scanning
- CVE tracking and prioritization

✅ **Risk-Based Approach**
- Acceptable risk with strong mitigations (Vaultwarden)
- Elimination of high-risk services (Watchtower)
- Prioritization based on exposure + criticality

✅ **Defense in Depth**
- Firewall rules
- Network isolation
- Service hardening
- Monitoring & alerting

---

## Next Steps

**Waiting for SAML lab scan to complete...**

Then we'll:
1. Analyze SAML lab vulnerabilities
2. Prioritize any critical findings
3. Create remediation plan
4. Update vulnerability tracking dashboard

---

## Session Status

**Current:** Reviewing background scan results + running new SAML lab scan
**Next:** Analyze SAML lab results and create action items

